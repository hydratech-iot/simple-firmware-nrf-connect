# STWLC38 Driver

## Requirements

This driver requires the STWLC38 wireless charger chip. This is present on the `STEVAL-WLC38RX` board.


------

## Description

This driver provides API to update STWLC38 firmware and configurations. The driver is written in C programming language and developed based way below:
1.    Platform independent driver which users could easily integrate the driver without any modification needed. 
1.    Written in a way of clear and self-explainable sequences, as references to user if need to re-write the sequences in different code formatting.

The code documentation can be generated using the Doxygen tool.

------

## Hardware Setup
1. Connect a **5V** power supply to VRECT or VOUT
2. Connect the STWLC I2C pins to the master I2C bus.

------

## Source Code Integration
1. Include the driver files (.h and .c) and nvm_data.h which generated by [STSW-WPSTUDIO GUI](https://www.st.com/en/embedded-software/stsw-wpstudio.html).

2. Define platform functions and variables to be used by driver API. See below for the function definitions.

```
    int32_t platform_write(void *phandle, uint8_t *wbuf, int32_t wlen);
    int32_t platform_write_read(void *phandle, uint8_t *wbuf, int32_t wlen, uint8_t *rbuf, int32_t rlen);
    void platform_delay(uint32_t millisec);
    void *platform_alloc_mem(size_t size);
    void platform_free_mem(void *ptr);
```

3. Declare and initialize driver interfaces
- To use this driver, users need to declare and assign the platform functions to mandatory interfaces.

```
    /** stwlc38 is the used part number **/ 
    struct stwlc38_dev stwlc38 = { 0 };

    stwlc38.bus_write = platform_write;
    stwlc38.bus_write_read = platform_write_read;
    stwlc38.mdelay = platform_delay;
    stwlc38.alloc_mem = platform_alloc_mem;
    stwlc38.free_mem = platform_free_mem;
```

- If user data is needed by the platform functions, initialize the phandle parameter.

```
    struct stmdev_platform {
        I2C_HandleTypeDef *hi2c;
        UART_HandleTypeDef *huart;
    };

    struct stmdev_platform platform = {
        .hi2c = &hi2c1,
        .huart = &huart3,
    };
    stwlc38.phandle = &platform;
```

- Optionally, users can print the log messages by initializing log parameters and set log_info to 1 to print more information logs.

```
    stwlc38.log = platform_log;
    stwlc38.log_info = 1;
```

- If host support only static memory allocation , user to allocate static memory instead of default dymanic memory allocation.

```
    #define USE_STATIC_ALLOC_RW 1
```

- Read chip information.
```
    struct stwlc38_chip_info info = { 0 };
	if (stwlc38_get_chip_info(&stwlc38, &info) != STWLC38_OK)
		return;
```

- Perform FW update.
```
	if (stwlc38_fw_update(&stwlc38, STWLC38_FW_PATCH_CFG, 0) != STWLC38_OK)
		return;
```

------

## FAQ

1. There is an I2C transaction NACK error that happened when writing system reset command to STWLC38.

    This is a known issue and its limitation of STWLC38. 
    Host shall ignore this error and proceed with the following I2C transactions. Users may implement conditional error handling. 

------
## Appendix

### Example Code using STM32 MCU
#### stwlc38_fw_update_example.c

```
/**
  ******************************************************************************
  * @file    	stwlc38_fw_update_example.c
  * @brief   	The file provide an example to perform FW update on STWLC38 using
  * 			stwlc38-pid.
  *
  ******************************************************************************
  * @attention
  *
  * This file is part of stwlc38-pid.
  *
  * Copyright (c) 2023, STMicroelectronics - All Rights Reserved
  * Author(s): ACD (Analog Custom Devices) Software Team for STMicroelectronics.
  *
  * License terms: BSD 3-clause "New" or "Revised" License.
  *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions are met:
  *
  * 1. Redistributions of source code must retain the above copyright notice, this
  * list of conditions and the following disclaimer.
  *
  * 2. Redistributions in binary form must reproduce the above copyright notice,
  * this list of conditions and the following disclaimer in the documentation
  * and/or other materials provided with the distribution.
  *
  * 3. Neither the name of the copyright holder nor the names of its contributors
  * may be used to endorse or promote products derived from this software
  * without specific prior written permission.
  *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
  * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *
  ******************************************************************************
  */

/**
  * This example is developed using following STMicroelectronics evaluation boards:
  *
  * - NUCLEO-H503RB
  * - NUCLEO-H563ZI
  *
  *
  * If you need to run this example on a different hardware platform a modification
  * of the structure and functions: `stmdev_platform`, `platform_write`,
  * `platform_write_read`, `platform_delay`, `platform_free_mem` and 'platform_log'
  * is required
  * and remove `HAL_I2C_MasterTxCpltCallback` and `HAL_I2C_MasterRxCpltCallback`.
  *
  *******************************************************************************
  *
  * IOC configurations need to use example below:
  *
  * Peripherals settings:
  * 1. USART3 - For console printing purpose.
  * 2. I2C1
  * 	- In NVIC settings, enable I2C1 Event and Error Interrupt.
  *
  * Generated files settings:
  * 1. Open .ioc files, navigate to `Project Manager` and click `Code Generator` tab.
  * 2. In `Generate Files` column, check the box of `Generate peripheral
  *    initialization as pair of ".c/.h" files per peripheral`.
  * 3. Save .ioc and generate code.
  *
 */

/* Includes ------------------------------------------------------------------*/
#include "i2c.h"
#include "usart.h"

#include <stdlib.h>
#include "stwlc38.h"

/* Private define ------------------------------------------------------------*/
#define USE_STATIC_ALLOC_RW 0
#if USE_STATIC_ALLOC_RW
static uint8_t stwlc_alloc_buf[258] = { 0x00 };
#endif

struct stmdev_platform {
    I2C_HandleTypeDef *hi2c;
    UART_HandleTypeDef *huart;
};

/* Private function prototypes -----------------------------------------------*/
int32_t platform_write(void *phandle, uint8_t *wbuf, int32_t wlen);
int32_t platform_write_read(void *phandle, uint8_t *wbuf, int32_t wlen, uint8_t *rbuf, int32_t rlen);
void platform_delay(uint32_t millisec);
void *platform_alloc_mem(size_t size);
void platform_free_mem(void *ptr);

/* Private variables ---------------------------------------------------------*/
static uint8_t i2cSequentialRxDone = 0;
static uint8_t i2cSequentialTxDone = 0;

/**
  * @brief  Master Tx Transfer completed callback.
  * @param  hi2c Pointer to a I2C_HandleTypeDef structure that contains
  *                the configuration information for the specified I2C.
  * @retval None
  */
/* Private user code ---------------------------------------------------------*/
void HAL_I2C_MasterTxCpltCallback(I2C_HandleTypeDef *hi2c)
{
    i2cSequentialTxDone = 1;
}

/**
  * @brief  Master Rx Transfer completed callback.
  * @param  hi2c Pointer to a I2C_HandleTypeDef structure that contains
  *                the configuration information for the specified I2C.
  * @retval None
  */

void HAL_I2C_MasterRxCpltCallback(I2C_HandleTypeDef *hi2c)
{
    i2cSequentialRxDone = 1;
}

/*
 * @brief  platform I2C write (platform dependent)
 * @param  phandle        Pointer to platform handle.
 * @param  wbuf		  	  Pointer to bytes to be written into STWLC38
 * @param  wlen			  Size of bytes to be written
 *
 * @retval error status (MANDATORY: return 0 -> no Error)
 */

int32_t platform_write(void *phandle, uint8_t *wbuf, int32_t wlen)
{
    struct stmdev_platform *platform = (struct stmdev_platform *)phandle;
    HAL_StatusTypeDef status = HAL_OK;
    uint32_t startTick;

    i2cSequentialTxDone = 0;
    startTick = HAL_GetTick();

    status = HAL_I2C_Master_Seq_Transmit_IT(platform->hi2c, STWLC38_I2C_ADDR << 1, wbuf, wlen, I2C_FIRST_AND_LAST_FRAME);
    if(status != HAL_OK)
        return status;

    while(i2cSequentialTxDone == 0)
    {
        if((HAL_GetTick() - startTick) > 1000)
        {
            /* I2C NACK WORKAROUND */
            /* Process Unlocked */
            __HAL_LOCK(platform->hi2c);

            /* Clear STOP Flag */
            __HAL_I2C_CLEAR_FLAG(platform->hi2c, I2C_FLAG_STOPF);

            /* Clear Configuration Register 2 */
            I2C_RESET_CR2(platform->hi2c);

            platform->hi2c->State = HAL_I2C_STATE_READY;
            platform->hi2c->Mode  = HAL_I2C_MODE_NONE;

            /* Process Unlocked */
            __HAL_UNLOCK(platform->hi2c);

            return 0;
        }
    }

    return 0;
}

/*
 * @brief  platform I2C write (platform dependent)
 * @param  phandle        Pointer to platform handle.
 * @param  wbuf		  	  Pointer to bytes to be written into STWLC38
 * @param  wlen			  Size of bytes to be written
 * @param  rbuf		  	  Pointer to hold the bytes read from STWLC38
 * @param  rlen			  Size of bytes to be read
 *
 * @retval error status (MANDATORY: return 0 -> no Error)
 */
int32_t platform_write_read(void *phandle, uint8_t *wbuf, int32_t wlen, uint8_t *rbuf, int32_t rlen)
{
    struct stmdev_platform *platform = (struct stmdev_platform *)phandle;
    HAL_StatusTypeDef status = HAL_OK;
    uint32_t startTick;

    i2cSequentialTxDone = 0;
    i2cSequentialRxDone = 0;
    startTick = HAL_GetTick();

    status = HAL_I2C_Master_Seq_Transmit_IT(platform->hi2c, STWLC38_I2C_ADDR << 1, wbuf, wlen, I2C_FIRST_FRAME);
    if(status != HAL_OK)
        return status;

    while(i2cSequentialTxDone == 0)
    {
        if((HAL_GetTick() - startTick) > 1000)
        {
            return HAL_TIMEOUT;
        }
    }

    status = HAL_I2C_Master_Seq_Receive_IT(platform->hi2c, STWLC38_I2C_ADDR << 1, rbuf, rlen, I2C_LAST_FRAME);
    if(status != HAL_OK)
        return status;

    while(i2cSequentialRxDone == 0)
    {
        if((HAL_GetTick() - startTick) > 1000)
            return HAL_TIMEOUT;
    }

    return 0;
}

/*
 * @brief  platform specific delay (platform dependent)
 * @param  millisec        delay in milliseconds
 *
 */
void platform_delay(uint32_t millisec)
{
    HAL_Delay(millisec);
}

/*
 * @brief  platform allocate memory (platform dependent)
 * @param  size        Memory size to be allocated
 *
 * @retval Pointer to allocated memory
 *
 */
void *platform_alloc_mem(size_t size)
{
#if USE_STATIC_ALLOC_RW
	return (void*) stwlc_alloc_buf;
#else
    return malloc(size);
#endif
}

/*
 * @brief  platform free memory (platform dependent)
 * @param  ptr        Pointer to memory to be free
 *
 */
void platform_free_mem(void *ptr)
{
#ifndef USE_STATIC_ALLOC_RW
    free(ptr);
#endif
}

/*
 * @brief  platform print output (platform dependent)
 * @param  phandle        Pointer to platform handle.
 * @param  level		  log level
 * @param  msg			  message to be printed
 * @param  len			  size of message
 *
 * @retval None
 *
 */
void platform_log(void *phandle, int32_t level, const char *msg, int32_t len)
{
	struct stmdev_platform *platform = (struct stmdev_platform *)phandle;

	HAL_UART_Transmit(platform->huart, (uint8_t *)msg, len, 1000);
}

/* Main Example --------------------------------------------------------------*/
void stwlc38_fw_update_example(void)
{
	/** stwlc38 is the used part number **/
	struct stmdev_platform platform = { 0 };
	struct stwlc38_dev stwlc38 = { 0 };
	struct stwlc38_chip_info info = { 0 };

	platform.hi2c = &hi2c1;
	platform.huart = &huart3;

	stwlc38.bus_write = platform_write;
	stwlc38.bus_write_read = platform_write_read;
	stwlc38.mdelay = platform_delay;
	stwlc38.alloc_mem = platform_alloc_mem;
	stwlc38.free_mem = platform_free_mem;
	stwlc38.phandle = &platform;
	stwlc38.log = platform_log;
	stwlc38.log_info = 1;

	if (stwlc38_get_chip_info(&stwlc38, &info) != STWLC38_OK)
		return;

	if (stwlc38_fw_update(&stwlc38, STWLC38_FW_PATCH_CFG, 0) != STWLC38_OK)
		return;
}
```

------

**More Information: [ST wireless charger ICs](https://www.st.com/en/power-management/wireless-charger-ics)**

**Copyright (C) 2023 STMicroelectronics**